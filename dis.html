<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Discount Manager</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        :root {
            --primary: #2563eb;
            --secondary: #64748b;
            --sidebar-bg: #1e293b;
            --sidebar-text: #f8fafc;
            --bg: #f1f5f9;
            --surface: #ffffff;
            --text: #0f172a;
            --border: #e2e8f0;
            --radius: 12px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --sidebar-width: 250px;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        body { margin: 0; background-color: var(--bg); color: var(--text); display: flex; min-height: 100vh; overflow-x: hidden; }

        /* Sidebar */
        .sidebar { width: var(--sidebar-width); background-color: var(--sidebar-bg); color: var(--sidebar-text); display: flex; flex-direction: column; padding: 1.5rem 1rem; position: fixed; top: 0; bottom: 0; left: 0; z-index: 1000; transition: transform 0.3s ease; }
        .sidebar-header { font-size: 1.25rem; font-weight: 700; margin-bottom: 2rem; color: white; padding-bottom: 1rem; border-bottom: 1px solid #334155; display: flex; align-items: center; gap: 10px; }
        .sidebar a { color: #cbd5e1; text-decoration: none; padding: 0.8rem 1rem; border-radius: 8px; margin-bottom: 0.5rem; display: block; font-weight: 500; transition: all 0.2s; }
        .sidebar a:hover { background-color: var(--primary); color: white; padding-left: 1.5rem; }
        .sidebar a.active { background-color: #334155; color: white; }

        .main-content { margin-left: var(--sidebar-width); flex: 1; padding: 0; width: calc(100% - var(--sidebar-width)); }
        .menu-toggle { display: none; background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; margin-right: 1rem; }
        .overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 999; }

        /* Header */
        header { background: var(--primary); color: white; padding: 1rem; display: flex; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 50; justify-content: space-between; }
        header h1 { margin: 0; font-size: 1.25rem; font-weight: 700; flex: 1; }

        /* Content */
        main { padding: 1rem; max-width: 1200px; margin: 0 auto; }
        .card { background: var(--surface); padding: 1.5rem; border-radius: var(--radius); box-shadow: var(--shadow); margin-bottom: 1.5rem; }
        
        /* Inputs & Buttons */
        input { padding: 0.8rem; border: 1px solid var(--border); border-radius: 6px; width: 100%; font-size: 1rem; }
        .btn { padding: 0.8rem 1.2rem; border: none; border-radius: var(--radius); font-weight: 600; cursor: pointer; color: white; white-space: nowrap; }
        .btn-search { background-color: var(--primary); }
        .btn-add { background-color: #10b981; }
        .btn-clear { background-color: var(--secondary); }
        
        /* Table */
        .table-container { overflow-x: auto; border-radius: var(--radius); border: 1px solid var(--border); }
        table { width: 100%; border-collapse: collapse; min-width: 900px; }
        th { background-color: #f8fafc; padding: 12px; text-align: left; font-weight: 600; color: #475569; border-bottom: 2px solid var(--border); }
        td { padding: 12px; border-bottom: 1px solid var(--border); font-size: 0.95rem; vertical-align: middle; }
        
        .price-tag { font-weight: 700; }
        .discount-amt { color: #ef4444; }
        .discount-pct { color: #22c55e; font-weight: bold; }
        .total-vat { color: #0f172a; font-weight: 800; font-size: 1.05rem; }

        /* Mobile */
        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); width: 250px; }
            .sidebar.open { transform: translateX(0); }
            .main-content { margin-left: 0; width: 100%; }
            .menu-toggle { display: block; }
        }
    </style>
</head>
<body>

<div class="overlay" id="overlay" onclick="toggleSidebar()"></div>

<!-- Sidebar -->
<div class="sidebar" id="sidebar">
    <div class="sidebar-header"><span>ðŸ“¦ Stock Manager</span></div>
    <nav>
        <a href="index.html">Search Stock</a>
        <a href="Audit.html">Inventory Audit</a>
        <a href="dis.html" class="active">Dis Product</a>
    </nav>
</div>

<div class="main-content">
    <header>
        <div style="display:flex; align-items:center;">
            <button class="menu-toggle" onclick="toggleSidebar()">â˜°</button>
            <h1>Discount Manager</h1>
        </div>
    </header>

    <main>
        <!-- SEARCH SECTION -->
        <div class="card">
            <h3 style="margin-top:0;">Search SKU</h3>
            <div style="display:flex; gap:10px; margin-bottom:10px;">
                <input type="text" id="searchInput" placeholder="Enter Barcode/SKU..." autofocus>
                <button class="btn btn-search" onclick="searchDiscount()">Search</button>
            </div>
            <div id="statusMsg" style="font-size:0.9rem; color: var(--secondary);"></div>
        </div>

        <!-- ADD/UPDATE FORM -->
        <div class="card" id="addSection" style="display:none; border-left: 4px solid #10b981;">
            <h4 style="margin-top:0; color:#10b981;">Manage Discount</h4>
            <input type="hidden" id="editBarcode">
            
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div>
                    <label style="display:block; font-size:0.8rem; margin-bottom:5px;">Actual Price</label>
                    <input type="number" id="editActualPrice" placeholder="0.00">
                </div>
                <div>
                    <label style="display:block; font-size:0.8rem; margin-bottom:5px;">Discount Price</label>
                    <input type="number" id="editDiscountPrice" placeholder="0.00">
                </div>
            </div>

            <div style="margin-top:15px; text-align:right;">
                <button class="btn btn-add" onclick="saveDiscount()">Save Discount</button>
                <button class="btn btn-clear" onclick="closeEdit()">Cancel</button>
            </div>
        </div>

        <!-- TABLE -->
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th style="width: 150px;">SKU</th>
                        <th>Actual Price</th>
                        <th>Discount Price</th>
                        <th>Discount %</th>
                        <th>Discount Amount</th>
                        <th>Total (Inc 10% VAT)</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="resultBody">
                    <tr>
                        <td colspan="7" style="text-align:center; padding: 2rem; color: var(--secondary);">
                            Search for a SKU to view details
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </main>
</div>

<script>
    const SUPABASE_URL = "https://vrsdpyodfejjuihutgag.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZyc2RweW9kZmVqanVpaHV0Z2FnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3MDU1MjAsImV4cCI6MjA4MzI4MTUyMH0.lHEpLJDfeHBRWElnW11wggWr59yXSgRAff3n1ZFTeDE";
    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    document.getElementById('searchInput').addEventListener('keypress', function (e) {
        if (e.key === 'Enter') searchDiscount();
    });

    function toggleSidebar() {
        document.getElementById('sidebar').classList.toggle('open');
        document.getElementById('overlay').classList.toggle('show');
    }

    async function searchDiscount() {
        const sku = document.getElementById('searchInput').value.trim();
        const tbody = document.getElementById('resultBody');
        const statusDiv = document.getElementById('statusMsg');

        if(!sku) return;

        statusDiv.textContent = "Searching...";
        closeEdit();
        tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;">Loading...</td></tr>';

        try {
            // Fetch ONLY from discounted_items table (No Inventory Join)
            const { data, error } = await sb
                .from('discounted_items')
                .select('*')
                .eq('barcode', sku)
                .maybeSingle();

            if (error || !data) {
                // If not found, clear table and show "Add" button option
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align:center;">
                            SKU not found in discount list.<br>
                            <button class="btn btn-add" style="margin-top:10px; padding: 0.5rem 1rem;" onclick="openEdit('${sku}', '', '')">Add New Discount</button>
                        </td>
                    </tr>`;
                statusDiv.textContent = "";
                return;
            }

            // Data Found - Perform Calculations
            const actualPrice = parseFloat(data.actual_price || 0);
            const discountPrice = parseFloat(data.discount_price || 0);
            
            const discountAmt = actualPrice - discountPrice;
            const discountPct = actualPrice > 0 ? ((discountAmt / actualPrice) * 100).toFixed(2) : 0;
            const totalWithVat = discountPrice + (discountPrice * 0.10);

            tbody.innerHTML = '';
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td style="font-weight:bold; color:var(--primary);">${data.barcode}</td>
                <td class="price-tag">$${actualPrice.toFixed(2)}</td>
                <td class="price-tag" style="color:#ef4444;">$${discountPrice.toFixed(2)}</td>
                <td class="discount-pct">${discountPct}%</td>
                <td class="discount-amt">$${discountAmt.toFixed(2)}</td>
                <td class="total-vat">$${totalWithVat.toFixed(2)}</td>
                <td>
                    <button class="btn btn-search" style="font-size:0.8rem; padding:0.5rem;" onclick="openEdit('${sku}', ${actualPrice}, ${discountPrice})">
                        Edit
                    </button>
                </td>
            `;
            tbody.appendChild(tr);
            statusDiv.textContent = "Discount found.";

        } catch (err) {
            console.error(err);
            tbody.innerHTML = `<tr><td colspan="7" style="text-align:center;">Error loading data.</td></tr>`;
            statusDiv.textContent = "";
        }
    }

    function openEdit(sku, actual, discount) {
        document.getElementById('addSection').style.display = 'block';
        document.getElementById('editBarcode').value = sku;
        document.getElementById('editActualPrice').value = actual;
        document.getElementById('editDiscountPrice').value = discount;
        document.getElementById('editActualPrice').focus();
    }

    function closeEdit() {
        document.getElementById('addSection').style.display = 'none';
    }

    async function saveDiscount() {
        const sku = document.getElementById('editBarcode').value;
        const actual = parseFloat(document.getElementById('editActualPrice').value);
        const discount = parseFloat(document.getElementById('editDiscountPrice').value);

        if(isNaN(actual) || actual < 0) return alert("Please enter a valid Actual Price");
        if(isNaN(discount) || discount < 0) return alert("Please enter a valid Discount Price");

        const payload = {
            barcode: sku,
            actual_price: actual,
            discount_price: discount
        };

        const { error } = await sb
            .from('discounted_items')
            .upsert(payload, { onConflict: 'barcode' });

        if(error) {
            alert("Error saving: " + error.message);
        } else {
            alert("Saved Successfully!");
            closeEdit();
            searchDiscount();
        }
    }
</script>
</body>
</html>
