<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Discount Manager</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        :root {
            --primary: #2563eb;
            --secondary: #64748b;
            --sidebar-bg: #1e293b;
            --sidebar-text: #f8fafc;
            --bg: #f1f5f9;
            --surface: #ffffff;
            --text: #0f172a;
            --border: #e2e8f0;
            --radius: 12px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --sidebar-width: 250px;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        body { margin: 0; background-color: var(--bg); color: var(--text); display: flex; min-height: 100vh; overflow-x: hidden; }

        /* Sidebar */
        .sidebar { width: var(--sidebar-width); background-color: var(--sidebar-bg); color: var(--sidebar-text); display: flex; flex-direction: column; padding: 1.5rem 1rem; position: fixed; top: 0; bottom: 0; left: 0; z-index: 1000; transition: transform 0.3s ease; }
        .sidebar-header { font-size: 1.25rem; font-weight: 700; margin-bottom: 2rem; color: white; padding-bottom: 1rem; border-bottom: 1px solid #334155; display: flex; align-items: center; gap: 10px; }
        .sidebar a { color: #cbd5e1; text-decoration: none; padding: 0.8rem 1rem; border-radius: 8px; margin-bottom: 0.5rem; display: block; font-weight: 500; transition: all 0.2s; }
        .sidebar a:hover { background-color: var(--primary); color: white; padding-left: 1.5rem; }
        .sidebar a.active { background-color: #334155; color: white; }

        .main-content { margin-left: var(--sidebar-width); flex: 1; padding: 0; width: calc(100% - var(--sidebar-width)); }
        .menu-toggle { display: none; background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; margin-right: 1rem; }
        .overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 999; }

        /* Header */
        header { background: var(--primary); color: white; padding: 1rem; display: flex; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 50; justify-content: space-between; }
        header h1 { margin: 0; font-size: 1.25rem; font-weight: 700; flex: 1; }

        /* Content */
        main { padding: 1rem; max-width: 1200px; margin: 0 auto; }
        .card { background: var(--surface); padding: 1.5rem; border-radius: var(--radius); box-shadow: var(--shadow); margin-bottom: 1.5rem; }
        
        /* Inputs & Buttons */
        input { padding: 0.8rem; border: 1px solid var(--border); border-radius: 6px; width: 100%; font-size: 1rem; }
        .btn { padding: 0.8rem 1.2rem; border: none; border-radius: var(--radius); font-weight: 600; cursor: pointer; color: white; white-space: nowrap; transition: opacity 0.2s; }
        .btn:hover { opacity: 0.9; }
        .btn-search { background-color: var(--primary); }
        .btn-add { background-color: #10b981; } 
        .btn-clear { background-color: var(--secondary); }
        .btn-save { background-color: #2563eb; }
        
        /* Top Bar Flexbox */
        .top-bar { display: flex; gap: 10px; align-items: center; margin-bottom: 10px; flex-wrap: wrap; }
        .search-input-group { flex: 1; min-width: 200px; display: flex; gap: 10px; }

        /* Table & Scroll Container */
        .table-container { 
            overflow-x: auto; /* Allows horizontal scroll on mobile */
            -webkit-overflow-scrolling: touch; /* Smooth scroll on iOS */
            border-radius: var(--radius); 
            border: 1px solid var(--border); 
        }
        table { 
            width: 100%; 
            border-collapse: collapse; 
            min-width: 700px; /* Reduced min-width since we removed a column */
        }
        th { background-color: #f8fafc; padding: 12px; text-align: left; font-weight: 600; color: #475569; border-bottom: 2px solid var(--border); white-space: nowrap; }
        td { padding: 12px; border-bottom: 1px solid var(--border); font-size: 0.95rem; vertical-align: middle; white-space: nowrap; }
        
        .price-tag { font-weight: 700; }
        .discount-pct { color: #22c55e; font-weight: bold; }
        .total-vat { color: #0f172a; font-weight: 800; font-size: 1.05rem; }
        .no-data { text-align: center; padding: 2rem; color: var(--secondary); white-space: normal; }

        /* Mobile */
        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); width: 250px; }
            .sidebar.open { transform: translateX(0); }
            .main-content { margin-left: 0; width: 100%; }
            .menu-toggle { display: block; }
            .top-bar { flex-direction: column; align-items: stretch; }
            .search-input-group { flex-direction: column; }
            /* Make text slightly smaller on mobile to fit more */
            th, td { padding: 10px 8px; font-size: 0.85rem; } 
        }
    </style>
</head>
<body>

<div class="overlay" id="overlay" onclick="toggleSidebar()"></div>

<!-- Sidebar -->
<div class="sidebar" id="sidebar">
    <div class="sidebar-header"><span>ðŸ“¦ Stock Manager</span></div>
    <nav>
        <a href="index.html">Search Stock</a>
        <a href="Audit.html">Inventory Audit</a>
        <a href="dis.html" class="active">Dis Product</a>
    </nav>
</div>

<div class="main-content">
    <header>
        <div style="display:flex; align-items:center;">
            <button class="menu-toggle" onclick="toggleSidebar()">â˜°</button>
            <h1>Discount Manager</h1>
        </div>
    </header>

    <main>
        <!-- SEARCH & ADD SECTION -->
        <div class="card">
            <h3 style="margin-top:0; margin-bottom: 15px;">Manage Discounts</h3>
            
            <div class="top-bar">
                <!-- Search Inputs -->
                <div class="search-input-group">
                    <input type="text" id="searchInput" placeholder="Search (e.g. BMP, SKU)">
                    <button class="btn btn-search" onclick="searchDiscount()">Search</button>
                </div>
                <!-- Add New Button -->
                <button class="btn btn-add" onclick="openAddForm()">+ Add New</button>
            </div>
            <div id="statusMsg" style="margin-top:10px; font-size:0.9rem; color: var(--secondary); min-height: 20px;"></div>
        </div>

        <!-- ADD/EDIT FORM -->
        <div class="card" id="addSection" style="display:none; border-left: 4px solid #2563eb;">
            <h4 style="margin-top:0; color:var(--primary);">Discount Details</h4>
            <input type="hidden" id="editBarcode">
            
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div>
                    <label style="display:block; font-size:0.8rem; margin-bottom:5px; font-weight:600;">SKU / Barcode</label>
                    <input type="text" id="editBarcodeDisplay" placeholder="Scan or type SKU">
                </div>
                <div></div> 
                <div>
                    <label style="display:block; font-size:0.8rem; margin-bottom:5px; font-weight:600;">Actual Price</label>
                    <input type="number" id="editActualPrice" placeholder="0.00" step="0.01">
                </div>
                <div>
                    <label style="display:block; font-size:0.8rem; margin-bottom:5px; font-weight:600;">Discount Price</label>
                    <input type="number" id="editDiscountPrice" placeholder="0.00" step="0.01">
                </div>
            </div>

            <div style="margin-top:15px; text-align:right;">
                <button class="btn btn-save" onclick="saveDiscount()">Save / Update</button>
                <button class="btn btn-clear" onclick="closeForm()">Cancel</button>
            </div>
        </div>

        <!-- TABLE -->
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th style="width: 150px;">SKU</th>
                        <th>Actual Price</th>
                        <th>Discount Price</th>
                        <th>Discount %</th>
                        <th>Total (Inc 10% VAT)</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="resultBody">
                    <tr>
                        <td colspan="6" class="no-data">
                            Search for an SKU or click "Add New" to start.
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </main>
</div>

<script>
    const SUPABASE_URL = "https://vrsdpyodfejjuihutgag.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZyc2RweW9kZmVqanVpaHV0Z2FnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3MDU1MjAsImV4cCI6MjA4MzI4MTUyMH0.lHEpLJDfeHBRWElnW11wggWr59yXSgRAff3n1ZFTeDE";
    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // Enter Key Support
    document.getElementById('searchInput').addEventListener('keypress', function (e) {
        if (e.key === 'Enter') searchDiscount();
    });

    document.getElementById('editBarcodeDisplay').addEventListener('keypress', function (e) {
        if (e.key === 'Enter') {
            document.getElementById('editBarcode').value = document.getElementById('editBarcodeDisplay').value;
            document.getElementById('editActualPrice').focus();
        }
    });

    function toggleSidebar() {
        document.getElementById('sidebar').classList.toggle('open');
        document.getElementById('overlay').classList.toggle('show');
    }

    // --- FORM ACTIONS ---

    function openAddForm() {
        document.getElementById('editBarcode').value = '';
        document.getElementById('editBarcodeDisplay').value = '';
        document.getElementById('editActualPrice').value = '';
        document.getElementById('editDiscountPrice').value = '';
        
        document.getElementById('addSection').style.display = 'block';
        document.getElementById('editBarcodeDisplay').focus();
        
        document.getElementById('resultBody').innerHTML = `
            <tr><td colspan="6" class="no-data">Enter details below to add a new discount.</td></tr>
        `;
    }

    function closeForm() {
        document.getElementById('addSection').style.display = 'none';
    }

    function openEditForm(barcode, actualPrice, discountPrice) {
        document.getElementById('editBarcode').value = barcode;
        document.getElementById('editBarcodeDisplay').value = barcode;
        document.getElementById('editActualPrice').value = actualPrice;
        document.getElementById('editDiscountPrice').value = discountPrice;
        
        document.getElementById('addSection').style.display = 'block';
    }

    // --- LOGIC ---

    async function searchDiscount() {
        const sku = document.getElementById('searchInput').value.trim();
        const tbody = document.getElementById('resultBody');
        const statusDiv = document.getElementById('statusMsg');

        if(!sku) return;

        statusDiv.textContent = "Searching...";
        closeForm(); 
        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">Loading...</td></tr>';

        try {
            // Use 'ilike' for case-insensitive partial matching
            const { data, error } = await sb
                .from('discounted_items')
                .select('*')
                .ilike('barcode', `%${sku}%`) 
                .order('barcode', { ascending: true })
                .limit(50);

            if (error) {
                console.error(error);
                statusDiv.textContent = "Database Error. Check Permissions.";
                tbody.innerHTML = `<tr><td colspan="6" class="no-data" style="color:red;">Error: ${error.message}</td></tr>`;
                return;
            }

            if (!data || data.length === 0) {
                // Not Found
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="no-data">
                            No results found for "<strong>${sku}</strong>".<br>
                            <button class="btn btn-add" style="margin-top:10px; padding: 0.5rem 1rem;" onclick="openAddFormFromSearch('${sku}')">Add New</button>
                        </td>
                    </tr>`;
                statusDiv.textContent = "No results found.";
            } else {
                // Found - Render Table
                renderTable(data);
                statusDiv.textContent = `Found ${data.length} result(s).`;
            }

        } catch (err) {
            console.error(err);
            tbody.innerHTML = `<tr><td colspan="6" class="no-data">Unexpected Error.</td></tr>`;
        }
    }

    function openAddFormFromSearch(sku) {
        document.getElementById('editBarcode').value = sku;
        document.getElementById('editBarcodeDisplay').value = sku;
        document.getElementById('editActualPrice').value = '';
        document.getElementById('editDiscountPrice').value = '';
        
        document.getElementById('addSection').style.display = 'block';
        document.getElementById('editActualPrice').focus();
    }

    function renderTable(dataArray) {
        const tbody = document.getElementById('resultBody');
        tbody.innerHTML = '';

        dataArray.forEach(item => {
            const actualPrice = parseFloat(item.actual_price || 0);
            const discountPrice = parseFloat(item.discount_price || 0);
            
            // Calculations
            const discountPct = actualPrice > 0 ? (((actualPrice - discountPrice) / actualPrice) * 100).toFixed(2) : 0;
            const totalWithVat = discountPrice + (discountPrice * 0.10); 

            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td style="font-weight:bold; color:var(--primary);">${item.barcode}</td>
                <td class="price-tag">${actualPrice.toFixed(2)}</td>
                <td class="price-tag" style="color:#ef4444;">${discountPrice.toFixed(2)}</td>
                <td class="discount-pct">${discountPct}%</td>
                <td class="total-vat">${totalWithVat.toFixed(2)}</td>
                <td>
                    <button class="btn btn-search" style="font-size:0.8rem; padding:0.5rem;" onclick="openEditForm('${item.barcode}', ${actualPrice}, ${discountPrice})">
                        Edit
                    </button>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    async function saveDiscount() {
        const sku = document.getElementById('editBarcodeDisplay').value.trim();
        const actual = parseFloat(document.getElementById('editActualPrice').value);
        const discount = parseFloat(document.getElementById('editDiscountPrice').value);

        if(!sku) return alert("Please enter a Barcode/SKU");
        if(isNaN(actual) || actual < 0) return alert("Please enter a valid Actual Price");
        if(isNaN(discount) || discount < 0) return alert("Please enter a valid Discount Price");

        const payload = {
            barcode: sku,
            actual_price: actual,
            discount_price: discount
        };

        const { error } = await sb
            .from('discounted_items')
            .upsert(payload, { onConflict: 'barcode' });

        if(error) {
            alert("Error saving: " + error.message);
            console.error(error);
        } else {
            alert("Saved Successfully!");
            closeForm();
            
            const currentSearch = document.getElementById('searchInput').value.trim();
            if(currentSearch && sku.toLowerCase().includes(currentSearch.toLowerCase())) {
                searchDiscount();
            } else {
                document.getElementById('resultBody').innerHTML = `<tr><td colspan="6" class="no-data">Saved! Search to view.</td></tr>`;
            }
        }
    }
</script>
</body>
</html>
