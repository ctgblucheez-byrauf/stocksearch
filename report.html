<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Audit Report</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Export Libraries -->
    <!-- SheetJS (Excel) -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    
    <!-- jspdf (PDF) with AutoTable plugin -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.0/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --secondary: #64748b;
            --sidebar-bg: #1e293b;
            --sidebar-text: #f8fafc;
            --bg: #f1f5f9;
            --surface: #ffffff;
            --text: #0f172a;
            --border: #e2e8f0;
            --radius: 12px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --sidebar-width: 250px;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        body { margin: 0; background-color: var(--bg); color: var(--text); display: flex; min-height: 100vh; overflow-x: hidden; }

        /* Layout */
        .sidebar { width: var(--sidebar-width); background-color: var(--sidebar-bg); color: var(--sidebar-text); display: flex; flex-direction: column; padding: 1.5rem 1rem; position: fixed; top: 0; bottom: 0; left: 0; z-index: 1000; transition: transform 0.3s ease; }
        .sidebar-header { font-size: 1.25rem; font-weight: 700; margin-bottom: 2rem; color: white; padding-bottom: 1rem; border-bottom: 1px solid #334155; display: flex; align-items: center; gap: 10px; }
        .sidebar a { color: #cbd5e1; text-decoration: none; padding: 0.8rem 1rem; border-radius: 8px; margin-bottom: 0.5rem; display: block; font-weight: 500; transition: all 0.2s; }
        .sidebar a:hover { background-color: var(--primary); color: white; padding-left: 1.5rem; }
        .sidebar a.active { background-color: #334155; color: white; }

        .main-content { margin-left: var(--sidebar-width); flex: 1; padding: 0; width: calc(100% - var(--sidebar-width)); }
        .menu-toggle { display: none; background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; margin-right: 1rem; }
        .overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 999; }

        /* Header */
        header { background: var(--primary); color: white; padding: 1rem; display: flex; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 50; justify-content: space-between; }
        header h1 { margin: 0; font-size: 1.25rem; font-weight: 700; flex: 1; }

        /* Main Content */
        main { padding: 1rem; max-width: 1200px; margin: 0 auto; }

        /* Report Header & Export */
        .report-header { background: var(--surface); padding: 1.5rem; border-radius: var(--radius); box-shadow: var(--shadow); margin-bottom: 2rem; border: 1px solid var(--border); display: flex; justify-content: space-between; align-items: flex-start; gap: 1rem; flex-wrap: wrap; }
        .report-title { margin: 0 0 1rem 0; font-size: 1.5rem; color: var(--primary); }
        
        .report-meta { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 0.5rem; }
        .meta-label { font-size: 0.85rem; font-weight: 600; }
        .meta-value { font-size: 1rem; color: var(--text); }

        .export-actions { display: flex; gap: 10px; align-items: center; margin-top: 1rem; }
        .btn-excel { background-color: #10b981; color: white; padding: 0.6rem 1.2rem; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 0.5rem; font-size: 0.9rem; }
        .btn-excel:hover { background-color: #059669; }
        
        .btn-pdf { background-color: #64748b; color: white; padding: 0.6rem 1.2rem; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 0.5rem; font-size: 0.9rem; }
        .btn-pdf:hover { background-color: #475569; }

        .back-link { color: var(--text); font-weight: 600; text-decoration: none; font-size: 0.9rem; cursor: pointer; }
        .back-link:hover { color: var(--primary); }

        /* Stats */
        .stats-bar { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
        .stat-card { background: var(--surface); padding: 1.5rem; border-radius: var(--radius); box-shadow: var(--shadow); text-align: center; border-top: 4px solid var(--primary); }
        .stat-val { font-size: 2rem; font-weight: 800; color: var(--primary); display: block; margin-bottom: 0.5rem; }
        .stat-label { font-size: 0.9rem; color: var(--secondary); font-weight: 500; text-transform: uppercase; }
        .stat-missing { border-color: #ef4444; color: #ef4444; }
        .stat-extra { border-color: #3b82f6; color: #3b82f6; }
        .stat-ok { border-color: #22c55e; color: #22c55e; }
        .stat-sys { border-color: #8b5cf6; color: #8b5cf6; }

        /* Table */
        .filter-section { background: var(--surface); padding: 1rem; border-radius: var(--radius); box-shadow: var(--shadow); margin-bottom: 1.5rem; border: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .filter-select { padding: 0.6rem 1rem; border: 1px solid var(--border); border-radius: 6px; background: #f8fafc; font-size: 1rem; min-width: 200px; }
        .badge-filter { padding: 4px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; cursor: pointer; border: 1px solid var(--border); white-space: nowrap; }
        .badge-filter.active { background: var(--primary); color: white; border-color: var(--primary); }

        .table-container { background: var(--surface); border-radius: var(--radius); overflow: hidden; box-shadow: var(--shadow); border: 1px solid var(--border); overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 1000px; font-size: 0.95rem; }
        th, td { padding: 14px; text-align: left; border-bottom: 1px solid var(--border); font-size: 0.95rem; }
        th { background-color: #f8fafc; font-weight: 600; color: #475569; white-space: nowrap; }
        
        .badge { padding: 6px 10px; border-radius: 4px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; display: inline-block; }
        .badge-ok { background: #dcfce7; color: #166534; }
        .badge-missing { background: #fee2e2; color: #991b1b; }
        .badge-extra { background: #dbeafe; color: #1e40af; }

        .action-btn { padding: 6px 12px; border: none; border-radius: 4px; font-size: 0.85rem; cursor: pointer; color: white; font-weight: 600; }
        .btn-edit { background-color: #f59e0b; margin-right: 5px; }

        /* Loader */
        .loader { width: 20px; height: 20px; border: 2px solid #f3f4f6; border-bottom-color: #65a30d; border-radius: 50%; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Mobile */
        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); width: 250px; }
            .sidebar.open { transform: translateX(0); }
            .main-content { margin-left: 0; width: 100%; }
            .menu-toggle { display: block; }
            .stats-bar { grid-template-columns: 1fr 1fr; }
            .report-header { flex-direction: column; }
            .export-actions { width: 100%; justify-content: space-between; }
        }
    </style>
</head>
<body>

<div class="overlay" id="overlay" onclick="toggleSidebar()"></div>

<!-- Sidebar -->
<div class="sidebar" id="sidebar">
    <div class="sidebar-header"><span>ðŸ“¦ Stock Manager</span></div>
    <nav>
        <a href="index.html">Search Stock</a>
        <a href="Audit.html" class="active">Inventory Audit</a>
        <a href="dis.html">Dis Product</a>
    </nav>
</div>

<div class="main-content">
    <header>
        <div style="display:flex; align-items:center;">
            <button class="menu-toggle" onclick="toggleSidebar()">â˜°</button>
            <h1 id="pageTitle">Audit Report</h1>
        </div>
        <a class="back-link" href="Audit.html">Back to Audit List</a>
    </header>

    <main>
        <!-- Loading State -->
        <div id="loadingState" style="text-align:center; padding: 3rem; display: none;">
            <div class="loader"></div>
            <p style="margin-top: 1rem; color: var(--secondary);">Loading Report Data...</p>
        </div>

        <!-- Report Content (Hidden initially) -->
        <div id="reportContent" style="display: none;">
            
            <!-- Header Info -->
            <div class="report-header">
                <div style="flex: 1; flex-direction: column; gap: 0.5rem;">
                    <h2 id="rTitle" class="report-title">Audit Name</h2>
                    <div class="report-meta">
                        <div><span class="meta-label">Company:</span> <span class="meta-value" id="rCompany">-</span></div>
                        <div><span class="meta-label">Outlet:</span> <span class="meta-value" id="rOutlet">-</span></div>
                        <div><span class="meta-label">Date:</span> <span class="meta-value" id="rDate">-</span></div>
                        <div><span class="meta-label">Status:</span> <span class="meta-value" id="rStatus">-</span></div>
                        <div><span class="meta-label">Created By:</span> <span class="meta-value" id="rCreated">-</span></div>
                    </div>
                </div>

                <!-- Export Buttons -->
                <div class="export-actions">
                    <button class="btn-excel" onclick="exportToExcel()">ðŸ“Š Export Excel</button>
                    <button class="btn-pdf" onclick="exportToPDF()">ðŸ“‹ Export PDF</button>
                </div>
            </div>

            <!-- Stats -->
            <div class="stats-bar">
                <div class="stat-card stat-sys">
                    <div class="stat-val" id="statSysTotal">0</div>
                    <div class="stat-label">Total System Stock</div>
                </div>
                <div class="stat-card stat-ok">
                    <div class="stat-val" id="statTotalScans">0</div>
                    <div class="stat-label">Total Scans</div>
                </div>
                <div class="stat-card stat-missing">
                    <div class="stat-val" id="statMissing">0</div>
                    <div class="stat-label">Missing Qty</div>
                </div>
                <div class="stat-card stat-extra">
                    <div class="stat-val" id="statExtra">0</div>
                    <div class="stat-label">Extra Qty</div>
                </div>
                <div class="stat-card stat-ok">
                    <div class="stat-val" id="statOk">0</div>
                    <div class="stat-label">Items OK</div>
                </div>
            </div>

            <!-- Filters -->
            <div class="filter-section">
                <span style="font-weight: 600; color: var(--secondary);">Filter By:</span>
                <select id="productFilter" class="filter-select" onchange="renderTable()">
                    <option value="all">All Products</option>
                </select>
                <select id="statusFilter" class="filter-select" onchange="renderTable()">
                    <option value="all">All Status</option>
                    <option value="OK">OK Only</option>
                    <option value="Missing">Missing Only</option>
                    <option value="Extra">Extra Only</option>
                </select>
            </div>

            <!-- Table -->
            <div class="table-container">
                <table id="reportTable">
                    <thead>
                        <tr>
                            <th style="width: 150px;">Barcode</th>
                            <th>Product Name</th>
                            <th>Color</th> <!-- SPLIT -->
                            <th>Size</th>  <!-- SPLIT -->
                            <th>Style Code</th> <!-- ADDED -->
                            <th>System Balance</th>
                            <th>Scanned Qty</th>
                            <th>Missing</th>
                            <th>Extra</th>
                            <th>Status</th>
                            <th style="width: 80px;">Action</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <!-- Rows here -->
                    </tbody>
                </table>
            </div>
        </div>
    </main>
</div>

<script>
    const SUPABASE_URL = "https://vrsdpyodfejjuihutgag.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZyc2RweW9kZmVqanVpaHV0Z2FnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3MDU1MjAsImV4cCI6MjA4MzI4MTUyMH0.lHEpLJDfeHBRWElnW11wggWr59yXSgRAff3n1ZFTeDE";
    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let currentAuditId = null;
    let auditData = [];
    let currentAuditInfo = {};

    // Init
    window.addEventListener('load', () => {
        checkActiveAudit();
    });

    function toggleSidebar() {
        document.getElementById('sidebar').classList.toggle('open');
        document.getElementById('overlay').classList.toggle('show');
    }

    // --- DATA FETCHING ---

    async function checkActiveAudit() {
        const urlParams = new URLSearchParams(window.location.search);
        const id = urlParams.get('id');
        
        if (!id) {
            alert("No Audit ID found. Returning to dashboard.");
            setTimeout(() => window.location.href = "Audit.html", 1000);
            return;
        }

        await fetchAuditData(id);
    }

    async function fetchAuditData(id) {
        document.getElementById('loadingState').style.display = 'block';
        document.getElementById('reportContent').style.display = 'none';

        try {
            // 1. Fetch Session Info
            const { data: session, error: sessionError } = await sb.from('audit_sessions').select('*').eq('id', id).single();
            if (sessionError) throw sessionError;

            // 2. Set Global Variables
            currentAuditId = session.id;
            currentAuditInfo = session;

            // 3. Populate Header
            document.getElementById('rTitle').innerText = session.audit_name;
            document.getElementById('rCompany').innerText = session.company_name || '-';
            document.getElementById('rOutlet').innerText = session.outlet_name || '-';
            document.getElementById('rDate').innerText = new Date(session.audit_date).toLocaleDateString();
            document.getElementById('rStatus').innerText = session.status;
            document.getElementById('rCreated').innerText = session.created_by || '-';

            // 4. Fetch Inventory Data
            const { data, error: invError } = await sb.from('audit_inventory')
                .select('*')
                .eq('audit_id', id)
                .order('last_scanned_at', { ascending: false });

            if (invError) throw invError;

            // 5. Process Data (Calculations)
            // Ensure valid numbers to prevent "Unexpected number" error
            auditData = data.map(item => {
                const bal = parseFloat(item.balance) || 0;
                const sc = parseFloat(item.scanned_qty) || 0;
                
                // If parsing failed (NaN), set to 0
                if (isNaN(bal) || isNaN(sc)) {
                    console.warn("Invalid numeric data found, resetting to 0", item);
                    return { ...item, balance: 0, scanned_qty: 0, missing_qty: 0, extra_qty: 0, status: 'OK' };
                }

                let mis = bal - sc;
                let ext = sc - bal;
                if (mis < 0) mis = 0;
                if (ext < 0) ext = 0;
                
                let st = 'OK';
                if (mis > 0) st = 'Missing';
                if (ext > 0) st = 'Extra';

                return { ...item, missing_qty: mis, extra_qty: ext, status: st };
            });

            // 6. Update Stats & Render
            updateStats();
            renderTable();

            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('reportContent').style.display = 'block';
            document.getElementById('pageTitle').innerText = `Report: ${session.audit_name}`;

        } catch (err) {
            console.error("Report Load Error:", err);
            document.getElementById('loadingState').innerHTML = `<p style="color:red">Error loading audit.</p>`;
        }
    }

    // --- UI RENDERING ---

    function updateStats() {
        if (!auditData || !Array.isArray(auditData)) return;

        const totalSys = auditData.reduce((a, i) => a + (Number(i.balance) || 0), 0);
        const totalScans = auditData.reduce((a, i) => a + (Number(i.scanned_qty) || 0), 0);
        const missing = auditData.reduce((a, i) => a + (Number(i.missing_qty) || 0), 0);
        const extra = auditData.reduce((a, i) => a + (Number(i.extra_qty) || 0), 0);
        const ok = auditData.filter(i => i.status === 'OK').length;

        document.getElementById('statSysTotal').innerText = totalSys;
        document.getElementById('statTotalScans').innerText = totalScans;
        document.getElementById('statMissing').innerText = missing;
        document.getElementById('statExtra').innerText = extra;
        document.getElementById('statOk').innerText = ok;
    }

    function renderTable() {
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';

        if (!auditData || !Array.isArray(auditData)) return;

        const filterName = document.getElementById('productFilter').value;
        const filterStatus = document.getElementById('statusFilter').value;

        const filtered = auditData.filter(item => {
            const nameMatch = filterName === 'all' || item.name.includes(filterName);
            const statusMatch = filterStatus === 'all' || item.status === filterStatus;
            return nameMatch && statusMatch;
        });

        filtered.forEach(item => {
            const tr = document.createElement('tr');
            const badgeClass = item.status === 'Missing' ? 'badge-missing' : (item.status === 'Extra' ? 'badge-extra' : 'badge-ok');
            
            tr.innerHTML = `
                <td>${item.barcode}</td>
                <td>${item.name}</td>
                <td>${item.color || '-'}</td> <!-- SEPARATED COLOR -->
                <td>${item.size || '-'}</td>  <!-- SEPARATED SIZE -->
                <td>${item.style_code || '-'}</td> <!-- STYLE CODE -->
                <td>${item.balance}</td>
                <td style="font-weight:bold; color:var(--primary);">${item.scanned_qty}</td>
                <td style="color:red; font-weight:bold;">${item.missing_qty}</td>
                <td style="color:blue; font-weight:bold;">${item.extra_qty}</td>
                <td><span class="badge ${badgeClass}">${item.status}</span></td>
                <td>
                    <button class="action-btn btn-edit" onclick="editItem(${item.id}, ${item.scanned_qty})">Edit</button>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    // --- EXPORT FUNCTIONS (FINAL) ---

    // Export to Excel
    async function exportToExcel() {
        // 1. Validation
        if (!auditData || !Array.isArray(auditData) || auditData.length === 0) {
            alert("No data available to export.");
            return;
        }

        try {
            // 2. Create Data Array (Explicit Casting)
            const excelData = auditData.map(item => ({
                Barcode: String(item.barcode),
                Name: String(item.name || ''),
                Color: String(item.color || '-'),
                Size: String(item.size || '-'),
                'Style Code': String(item.style_code || '-'),
                'System Balance': Number(item.balance),
                'Scanned Qty': Number(item.scanned_qty),
                'Missing Qty': Number(item.missing_qty),
                'Extra Qty': Number(item.extra_qty),
                Status: String(item.status || '')
            }));

            // 3. Create Workbook
            const wb = XLSX.utils.book_new();

            // 4. Create Worksheet
            const wsData = [
                ["Barcode", "Name", "Color", "Size", "Style Code", "System Balance", "Scanned Qty", "Missing Qty", "Extra Qty", "Status"], // Header
            ];

            excelData.forEach(row => {
                wsData.push([
                    row['Barcode'],
                    row['Name'],
                    row['Color'],
                    row['Size'],
                    row['Style Code'],
                    row['System Balance'],
                    row['Scanned Qty'],
                    row['Missing Qty'],
                    row['Extra Qty'],
                    row['Status']
                ]);
            });

            const ws = XLSX.utils.aoa_to_sheet(wsData);
            
            // 5. Append to Workbook
            XLSX.utils.book_append_sheet(wb, ws, "Audit Report");

            // 6. Download
            XLSX.writeFile(wb, `Audit_Report_${currentAuditInfo.audit_name || 'Export'}.xlsx`);

            console.log("Excel Exported Successfully");

        } catch (error) {
            console.error("Excel Export Error:", error);
            alert("Excel Export Failed. Check console for details.");
        }
    }

    // Export to PDF (Robust & Safe)
    async function exportToPDF() {
        // 1. Validation
        if (!auditData || !Array.isArray(auditData) || auditData.length === 0) {
            alert("No data available to export.");
            return;
        }

        try {
            const { jsPDF } = window.jspdf;
            if (!jsPDF) {
                alert("PDF Library not loaded.");
                return;
            }

            const doc = new jsPDF({ orientation: "landscape", unit: "pt" });
            
            // Filter Data (Safe)
            const filterName = document.getElementById('productFilter').value;
            const filterStatus = document.getElementById('statusFilter').value;
            const filteredData = auditData.filter(item => {
                const nameMatch = filterName === 'all' || item.name.includes(filterName);
                const statusMatch = filterStatus === 'all' || item.status === filterStatus;
                return nameMatch && statusMatch;
            });

            // Data Sanitization Check for PDF
            const dataIsValid = filteredData.every(item => {
                return !isNaN(item.balance) && !isNaN(item.scanned_qty);
            });

            if (!dataIsValid) {
                alert("Data contains errors (non-numeric values). Cannot export PDF safely.");
                return;
            }

            const columns = [
                { header: "Barcode", dataKey: "barcode", width: 40 },
                { header: "Product Name", dataKey: "name", width: 60 },
                { header: "Color", dataKey: "color", width: 40 },
                { header: "Size", dataKey: "size", width: 40 },
                { header: "Style Code", dataKey: "style_code", width: 40 },
                { header: "System Balance", dataKey: "balance", width: 40 },
                { header: "Scanned Qty", dataKey: "scanned_qty", width: 40 },
                { header: "Missing", dataKey: "missing_qty", width: 30 },
                { header: "Extra", dataKey: "extra_qty", width: 30 },
                { header: "Status", dataKey: "status", width: 35 }
            ];

            const styles = {
                green: { fillColor: "#dcfce7", textColor: "#166534", fontStyle: "bold" },
                red: { fillColor: "#fee2e2", textColor: "#991b1b", fontStyle: "bold" },
                blue: { fillColor: "#dbeafe", textColor: "#1e40af", fontStyle: "bold" },
                grey: { fillColor: "#f1f5f9", textColor: "#0f172a", fontStyle: "bold" },
                black: { fillColor: "#ffffff", textColor: "#0f172a", fontStyle: "normal" }
            };

            const columnStyles = {
                barcode: { styles: styles.grey },
                name: { styles: styles.black },
                color: { styles: styles.black },
                size: { styles: styles.black },
                style_code: { styles: styles.black },
                balance: { styles: styles.black },
                scanned_qty: { styles: styles.black },
                missing_qty: { styles: styles.black },
                extra_qty: { styles: styles.black },
                status: (row) => row.status === 'OK' ? styles.green : (row.status === 'Missing' ? styles.red : styles.blue)
            };

            // 2. Safe Title
            const rawSessionName = document.getElementById('rTitle').innerText;
            const safeName = rawSessionName.replace(/`/g, "'").replace(/'/g, ""); // Remove quotes to prevent PDF syntax error

            // 3. Header Text
            doc.setFontSize(16);
            doc.setFont("helvetica", "bold");
            doc.text(`Audit Report: ${safeName}`, 14, doc.internal.pageSize.width / 2, 15);
            let yPosition = 25;

            // 4. Metadata
            doc.setFontSize(10);
            doc.setFont("helvetica", "normal");
            const company = document.getElementById('rCompany').innerText;
            const outlet = document.getElementById('rOutlet').innerText;
            const date = document.getElementById('rDate').innerText;
            const status = document.getElementById('rStatus').innerText;
            
            if (company !== '-') doc.text(`Company: ${company}`, 14, 14, yPosition, { align: 'left' });
            if (outlet !== '-') doc.text(`Outlet: ${outlet}`, 14, 14, yPosition, { align: 'left' });
            if (date !== '-') doc.text(`Date: ${date}`, 14, 14, yPosition, { align: 'left' });
            if (status !== '-') doc.text(`Status: ${status}`, 14, 14, yPosition, { align: 'left' });
            yPosition += 10;

            // 5. Draw Table (Manual Loop - Most Robust)
            const colWidths = [40, 60, 40, 40, 40, 40, 40, 30, 30, 35];
            const rowHeight = 12;

            // Header Background
            doc.setFillColor(59, 130, 246); // Blue
            doc.setTextColor(255, 255, 255); // White
            doc.setFontSize(11);
            doc.setFont("helvetica", "bold");
            doc.text("Barcode", colWidths[0], yPosition);
            doc.text("Product Name", colWidths[1], yPosition);
            doc.text("Color", colWidths[2], yPosition);
            doc.text("Size", colWidths[3], yPosition);
            doc.text("Style Code", colWidths[4], yPosition);
            doc.text("System Balance", colWidths[5], yPosition);
            doc.text("Scanned Qty", colWidths[6], yPosition);
            doc.text("Missing", colWidths[7], yPosition);
            doc.text("Extra", colWidths[8], yPosition);
            doc.text("Status", colWidths[9], yPosition);
            yPosition += 10;

            // Table Rows
            doc.setFillColor(255, 255, 255); // White BG
            doc.setTextColor(50, 50, 50); // Dark Grey Text
            doc.setFontSize(10);
            doc.setFont("helvetica", "normal");
            doc.setLineWidth(0.1);
            doc.setDrawColor({ lineColor: [229, 229, 229] }); // Line Color Light Grey

            filteredData.forEach((item) => {
                let x = 14;

                // Ensure numbers before adding/subtracting
                const bal = parseFloat(item.balance) || 0;
                const sc = parseFloat(item.scanned_qty) || 0;
                const mis = parseFloat(item.missing_qty) || 0;
                const ext = parseFloat(item.extra_qty) || 0;

                // Draw Cells
                doc.text(item.barcode, x, yPosition); x += colWidths[0];
                doc.text(item.name, x, yPosition); x += colWidths[1];
                doc.text(item.color || '-', x, yPosition); x += colWidths[2];
                doc.text(item.size || '-', x, yPosition); x += colWidths[3];
                doc.text(item.style_code || '-', x, yPosition); x += colWidths[4];
                doc.text(String(bal), x, yPosition); x += colWidths[5];
                doc.text(String(sc), x, yPosition); x += colWidths[6];
                doc.text(String(mis), x, yPosition); x += colWidths[7];
                doc.text(String(ext), x, yPosition); x += colWidths[8];

                // Status Color
                let color = [0, 0, 0];
                let text = "#0f172a";
                
                if (item.status === 'OK') { color = [34, 197, 94]; text = "#166534"; }
                if (item.status === 'Missing') { color = [239, 68, 68]; text = "#991b1b"; }
                if (item.status === 'Extra') { color = [59, 130, 246]; text = "#1e40af"; }
                
                doc.setFillColor(color);
                doc.rect(x, yPosition, colWidths[9], rowHeight);
                doc.setFillColor(255, 255, 255); // Reset to white text
                doc.setTextColor(color);
                doc.text(item.status, x + 2, yPosition + 2);
                doc.setTextColor(50, 50, 50); // Reset text color
                
                yPosition += 12; // Next row
            });

            doc.save(`Audit_Report_${safeName}.pdf`);

        } catch (error) {
            console.error("PDF Export Error:", error);
            alert("PDF Export Failed: " + error.message);
        }
    }

    // --- ACTIONS ---

    async function editItem(id, currentQty) {
        const input = prompt(`Enter new Scanned Qty:`, currentQty);
        if (input === null) return;
        
        // Validation to prevent NaN
        const newQty = parseInt(input);
        if (!newQty || newQty < 0) {
            alert("Please enter a valid positive number.");
            return;
        }

        const { error } = await sb.from('audit_inventory').update({ scanned_qty: newQty }).eq('id', id);
        
        if (error) {
            alert("Failed to update item.");
        } else {
            alert("Quantity Updated Successfully");
            fetchAuditData(currentAuditId); // Refresh data
        }
    }

    function goToEdit() {
        window.location.href = `Audit.html?id=${currentAuditId}`;
    }
</script>
</body>
</html>
