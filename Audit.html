<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Inventory Audit System</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --secondary: #64748b;
            --sidebar-bg: #1e293b;
            --sidebar-text: #f8fafc;
            --bg: #f1f5f9;
            --surface: #ffffff;
            --text: #0f172a;
            --border: #e2e8f0;
            --radius: 12px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --sidebar-width: 250px;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        body { margin: 0; background-color: var(--bg); color: var(--text); display: flex; min-height: 100vh; overflow-x: hidden; }

        /* Layout */
        .sidebar { width: var(--sidebar-width); background-color: var(--sidebar-bg); color: var(--sidebar-text); display: flex; flex-direction: column; padding: 1.5rem 1rem; position: fixed; top: 0; bottom: 0; left: 0; z-index: 1000; transition: transform 0.3s ease; }
        .sidebar-header { font-size: 1.25rem; font-weight: 700; margin-bottom: 2rem; color: white; padding-bottom: 1rem; border-bottom: 1px solid #334155; display: flex; align-items: center; gap: 10px; }
        .sidebar a { color: #cbd5e1; text-decoration: none; padding: 0.8rem 1rem; border-radius: 8px; margin-bottom: 0.5rem; display: block; font-weight: 500; transition: all 0.2s; }
        .sidebar a:hover { background-color: var(--primary); color: white; padding-left: 1.5rem; }
        .sidebar a.active { background-color: #334155; color: white; }

        .main-content { margin-left: var(--sidebar-width); flex: 1; padding: 0; width: calc(100% - var(--sidebar-width)); }
        .menu-toggle { display: none; background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; margin-right: 1rem; }
        .overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 999; }

        /* Header */
        header { background: var(--primary); color: white; padding: 1rem; display: flex; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 50; justify-content: space-between; }
        header h1 { margin: 0; font-size: 1.25rem; font-weight: 700; flex: 1; }

        /* Main Content */
        main { padding: 1rem; max-width: 1200px; margin: 0 auto; }

        /* Setup Card */
        .setup-card { background: var(--surface); padding: 1.5rem; border-radius: var(--radius); box-shadow: var(--shadow); margin-bottom: 1.5rem; border: 1px solid var(--border); }
        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1rem; }
        input, select { padding: 0.6rem; border: 1px solid var(--border); border-radius: 6px; width: 100%; }
        
        /* Add Item Panel */
        .add-item-panel { background: var(--surface); padding: 1.5rem; border-radius: var(--radius); box-shadow: var(--shadow); margin-bottom: 1.5rem; border: 1px solid var(--border); display: none; flex-direction: column; }
        .add-item-panel.open { display: flex; }
        
        .search-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border); flex-wrap: wrap; gap: 10px; }
        .mode-toggles { display: flex; gap: 5px; font-weight: 600; margin-bottom: 10px; }
        .mode-badge { cursor: pointer; padding: 6px 12px; border-radius: 20px; border: 1px solid var(--border); font-size: 0.8rem; text-transform: uppercase; }
        .mode-badge.active { background-color: var(--primary); color: white; border-color: var(--primary); }

        .search-input-wrap { display: flex; gap: 10px; }
        #inventorySearch { flex: 1; padding: 1rem; font-size: 1rem; border: 2px solid var(--primary); border-radius: var(--radius); }
        
        .search-results, .category-results { max-height: 350px; overflow-y: auto; border: 1px solid var(--border); border-radius: 8px; margin-bottom: 1rem; }
        
        /* Individual Items */
        .search-result-item { padding: 12px; border-bottom: 1px solid var(--border); cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: background 0.2s; }
        .search-result-item:hover { background-color: #f1f5f9; }
        .search-result-item.selected { background-color: #dbeafe; border-left: 4px solid var(--primary); }
        
        /* Category Items (Summary) */
        .category-item { padding: 16px; border-bottom: 1px solid var(--border); cursor: pointer; display: block; transition: background 0.2s; }
        .category-item:hover { background-color: #f1f5f9; }
        .category-item.selected { background-color: #dbeafe; border-left: 4px solid var(--primary); }

        .result-info strong { display: block; font-size: 1rem; color: var(--text); margin-bottom: 4px; }
        .result-meta { font-size: 0.9rem; color: var(--secondary); }
        .total-stock-highlight { font-size: 1.1rem; font-weight: 700; color: var(--primary); }

        .selection-summary { background: #eff6ff; padding: 1rem; border-radius: 8px; border: 1px solid #dbeafe; display: none; align-items: center; justify-content: space-between; }
        .selection-summary.has-items { display: flex; }
        .total-balance { font-weight: 700; color: var(--primary); font-size: 1.1rem; }
        .total-label { font-size: 0.85rem; color: var(--secondary); }

        /* Scanner Section */
        .scanner-section { background: var(--surface); padding: 1rem; border-radius: var(--radius); box-shadow: var(--shadow); margin-bottom: 1.5rem; display: flex; gap: 1rem; flex-wrap: wrap; align-items: center; border: 2px solid transparent; }
        .scanner-section.locked { border-color: #ef4444; opacity: 0.7; pointer-events: none; }
        #reader-wrapper { width: 300px; height: 250px; background: #000; border-radius: var(--radius); overflow: hidden; display: none; margin-left: auto; }
        #reader { width: 100%; height: 100%; object-fit: cover; }
        #reader a { display: none !important; }
        
        .btn { padding: 0.8rem 1.2rem; border: none; border-radius: var(--radius); font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; font-size: 0.9rem; color: white; text-decoration: none; }
        .btn-scan { background-color: var(--secondary); }
        .btn-new { background-color: var(--primary); }
        .btn-add { background-color: #f59e0b; width: 100%; }
        .btn-close { background-color: #ef4444; }
        .btn-merge { background-color: #8b5cf6; margin-top: 10px; }
        .btn-nav { background-color: #0f172a; width: 100%; margin-bottom: 10px; }

        /* Lists Wrapper */
        .lists-wrapper { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .audit-list-container { background: var(--surface); border-radius: var(--radius); overflow: hidden; box-shadow: var(--shadow); margin-top: 20px; display: flex; flex-direction: column; border: 1px solid var(--border); }
        .audit-list-wrapper { overflow-x: auto; width: 100%; }
        
        .merged-list-container { background: #f0fdf4; border-radius: var(--radius); overflow: hidden; box-shadow: var(--shadow); margin-top: 20px; display: flex; flex-direction: column; border: 1px solid var(--border); }
        .merged-list-wrapper { overflow-x: auto; width: 100%; }
        
        .audit-list-table { width: 100%; border-collapse: collapse; min-width: 800px; }
        .audit-list-table th { position: sticky; top: 0; z-index: 10; background-color: #f8fafc; padding: 12px; text-align: left; border-bottom: 1px solid var(--border); font-size: 0.8rem; color: #64748b; text-transform: uppercase; white-space: nowrap; }
        .audit-list-table td { padding: 12px; text-align: left; border-bottom: 1px solid var(--border); font-size: 0.9rem; }
        
        .action-link { color: var(--primary); font-weight: 600; margin-right: 10px; cursor: pointer; text-decoration: none; white-space: nowrap; }
        .action-link.delete { color: #ef4444; }
        
        /* Stats & Filter */
        .stats-bar { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; }
        .stat-card { background: var(--surface); padding: 1rem; border-radius: var(--radius); box-shadow: var(--shadow); text-align: center; border-top: 4px solid var(--primary); }
        .stat-val { font-size: 1.5rem; font-weight: 700; color: var(--primary); display: block; margin-bottom: 0.5rem; }
        .stat-label { font-size: 0.75rem; color: var(--secondary); font-weight: 500; text-transform: uppercase; }
        .stat-missing { border-color: #ef4444; color: #ef4444; } .stat-extra { border-color: #3b82f6; color: #3b82f6; } .stat-ok { border-color: #22c55e; color: #22c55e; } .stat-sys { border-color: #8b5cf6; color: #8b5cf6; }

        .filter-area { background: var(--surface); padding: 1rem; border-radius: var(--radius); margin-bottom: 1rem; display: flex; gap: 10px; align-items: center; border: 1px solid var(--border); }
        .badge-filter { padding: 4px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; cursor: pointer; border: 1px solid var(--border); white-space: nowrap; }
        .badge-filter.active { background: var(--primary); color: white; border-color: var(--primary); }

        .table-container { background: var(--surface); border-radius: var(--radius); overflow: hidden; box-shadow: var(--shadow); border: 1px solid var(--border); overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 900px; font-size: 0.9rem; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid var(--border); font-size: 0.9rem; }
        th { background-color: #f8fafc; font-weight: 600; color: #475569; white-space: nowrap; }
        
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; display: inline-block; }
        .badge-ok { background: #dcfce7; color: #166534; }
        .badge-missing { background: #fee2e2; color: #991b1b; }
        .badge-extra { background: #dbeafe; color: #1e40af; }
        .badge-merged { background: #8b5cf6; color: white; }

        .action-btn { padding: 4px 8px; font-size: 0.75rem; margin-right: 4px; cursor: pointer; border: none; border-radius: 4px; color: white; font-weight: 600; }
        .btn-edit { background-color: #f59e0b; }

        /* Loader */
        .loader { width: 20px; height: 20px; border: 2px solid #f3f4f6; border-bottom-color: #65a30d; border-radius: 50%; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Mobile */
        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); width: 250px; }
            .sidebar.open { transform: translateX(0); }
            .main-content { margin-left: 0; width: 100%; }
            .menu-toggle { display: block; }
            .scanner-section { flex-direction: column; }
            #reader-wrapper { margin: 0 auto; width: 100%; }
            .lists-wrapper { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

<div class="overlay" id="overlay" onclick="toggleSidebar()"></div>

<!-- Sidebar -->
<div class="sidebar" id="sidebar">
    <div class="sidebar-header"><span>ðŸ“¦ Stock Manager</span></div>
    <nav>
        <a href="index.html">Search Stock</a>
        <a href="Audit.html" class="active">Inventory Audit</a>
        <a href="dis.html">Dis Product</a>
    </nav>
</div>

<div class="main-content">
    <header>
        <div style="display:flex; align-items:center;">
            <button class="menu-toggle" onclick="toggleSidebar()">â˜°</button>
            <h1 id="pageTitle">Inventory Audit</h1>
        </div>
        <button class="btn btn-new" id="backToDashBtn" style="display:none; font-size:0.8rem; padding: 0.5rem 1rem;" onclick="loadDashboard()">Back to List</button>
    </header>

    <main>
        <!-- 1. DASHBOARD -->
        <div id="dashboardPanel">
            
            <!-- Create New Form -->
            <div class="setup-card">
                <h3 style="margin-top:0;">Start New Audit</h3>
                <div class="form-row">
                    <input type="text" id="auditName" placeholder="Audit Name">
                    <input type="text" id="entryBy" placeholder="Entry By">
                    <input type="date" id="auditDate">
                </div>
                <div style="text-align:right;">
                    <button class="btn btn-new" onclick="createNewAudit()">Create Audit</button>
                    <button class="btn btn-add" onclick="toggleAddPanel()">âž• Add Audit Item</button>
                </div>
            </div>

            <!-- ADD ITEM / CATEGORY PANEL -->
            <div id="addPanel" class="add-item-panel">
                <div class="search-header">
                    <div>
                        <h3 style="margin:0;">Add / Select Items</h3>
                        <div class="mode-toggles">
                            <span id="modeIndividual" class="mode-badge active" onclick="setMode('individual')">Search Items</span>
                            <span id="modeCategory" class="mode-badge" onclick="setMode('category')">View Categories</span>
                        </div>
                    </div>
                    <button class="btn btn-close" onclick="toggleAddPanel()">Close</button>
                </div>
                
                <!-- Search Input (Only visible in Individual Mode) -->
                <div id="individualSearchWrap" class="search-input-wrap">
                    <input type="text" id="inventorySearch" placeholder="Search product name / barcode..." autocomplete="off">
                </div>

                <!-- Results Container -->
                <div id="searchResults" class="search-results">
                    <p style="text-align:center; color:var(--secondary); padding:1rem;">Select a mode...</p>
                </div>

                <!-- Selection Summary -->
                <div id="selectionSummary" class="selection-summary">
                    <span class="total-label">Selected Items:</span>
                    <span id="totalSelectedBalance" class="total-balance">0</span>
                </div>

                <div style="margin-top: 1rem; text-align: right;">
                    <button class="btn btn-add" id="addSelectedBtn" style="width: 100%;" onclick="addSelectedItems()">Add Selected Items</button>
                </div>
            </div>

            <!-- Lists Wrapper -->
            <div class="lists-wrapper">
                
                <!-- Previous Audits List -->
                <div class="audit-list-container">
                    <div class="list-header" style="padding: 15px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-weight:700; color:var(--text);">Previous Audits</span>
                        <button class="btn btn-merge" onclick="mergeSelectedAudits()">Merge Selected</button>
                    </div>
                    <div class="audit-list-wrapper">
                        <table class="audit-list-table">
                            <thead>
                                <tr>
                                    <th style="width:40px;">Select</th>
                                    <th>Audit Name</th>
                                    <th>Outlet</th>
                                    <th>Date</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="auditListBody">
                                <!-- Rows injected via JS -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Merged Audits List -->
                <div class="merged-list-container">
                    <div class="list-header" style="padding: 15px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-weight:700; color:var(--text);">Merged Audits List</span>
                    </div>
                    <div class="merged-list-wrapper">
                        <table class="audit-list-table">
                            <thead>
                                <tr>
                                    <th>Merged Name</th>
                                    <th>Outlet</th>
                                    <th>Company</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="mergedListBody">
                                <!-- Rows injected via JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- 2. ACTIVE AUDIT VIEW -->
        <div id="activeAuditPanel" style="display:none;">
            
            <!-- Current Audit Info -->
            <div id="auditInfoPanel" style="margin-bottom:1.5rem; background: var(--primary); color:white; padding:1rem; border-radius:var(--radius); justify-content:space-between; align-items:center;">
                <div>
                    <h2 id="displayAuditName" style="margin:0;">Audit Name</h2>
                    <small id="displayInfo">Entry By - Date</small>
                </div>
                <div style="display:flex; gap:10px;">
                    <button class="btn btn-close" onclick="closeAudit()">Close Audit</button>
                </div>
            </div>

            <!-- SCANNER -->
            <div class="scanner-section" id="scanSection" style="display:none;">
                <input type="text" id="scanInput" class="scan-input" placeholder="Scan Barcode..." autofocus autocomplete="off">
                <button class="btn btn-scan" id="camBtn" onclick="toggleCamera()">ðŸ“¸ Cam</button>
                <div id="reader-wrapper"><div id="reader"></div></div>
            </div>

            <!-- LAST 10 SCANS -->
            <div class="history-bar" id="historyBar" style="display:none;">
                <span style="font-weight:700; color:var(--primary); margin-right:10px;">LAST 10 SCANS:</span>
                <div id="historyContainer" style="display:flex; gap:10px;"></div>
            </div>

            <!-- STATS -->
            <div class="stats-bar" id="statsBar" style="display:none;">
                <div class="stat-card">
                    <div class="stat-val" id="statTotal">0</div>
                    <div class="stat-label">Total Scans</div>
                </div>
                <div class="stat-card stat-red">
                    <div class="stat-val" id="statMissing">0</div>
                    <div class="stat-label">Missing Qty</div>
                </div>
                <div class="stat-card stat-blue">
                    <div class="stat-val" id="statExtra">0</div>
                    <div class="stat-label">Extra Qty</div>
                </div>
                <div class="stat-card stat-green">
                    <div class="stat-val" id="statOk">0</div>
                    <div class="stat-label">Items OK</div>
                </div>
                <div class="stat-card stat-purple">
                    <div class="stat-val" id="statSysTotal">0</div>
                    <div class="stat-label">Total Sys Stock</div>
                </div>
            </div>

            <!-- NAV BUTTONS -->
            <div style="margin-bottom: 1rem; display:grid; grid-template-columns: 1fr 1fr; gap:10px;" id="navButtons" style="display:none;">
                <button class="btn btn-nav" onclick="goToSummary()">Summary (summ.html)</button>
                <button class="btn btn-nav" style="background:#10b981;" onclick="goToReport()">Report (report.html)</button>
            </div>

            <!-- FILTER -->
            <div class="filter-area" id="filterArea" style="display:none;">
                <span style="font-weight:600; color:var(--secondary);">Filter By Product:</span>
                <select id="productFilter" onchange="renderTable()" style="flex:1;">
                    <option value="all">All Scanned Products</option>
                </select>
            </div>

            <!-- TABLE -->
            <div id="tableSection" style="display:none;">
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Barcode</th>
                                <th>Name</th>
                                <th>Color/Size</th>
                                <th>System Balance</th>
                                <th>Scanned</th>
                                <th>Missing</th>
                                <th>Extra</th>
                                <th>Status</th>
                                <th style="width: 80px;">Action</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                            <!-- Rows here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>
</div>

<script>
    const SUPABASE_URL = "https://vrsdpyodfejjuihutgag.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZyc2RweW9kZmVqanVpaHV0Z2FnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3MDU1MjAsImV4cCI6MjA4MzI4MTUyMH0.lHEpLJDfeHBRWElnW11wggWr59yXSgRAff3n1ZFTeDE";
    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let currentAuditId = null;
    let auditData = []; 
    let html5QrCode = null;
    let isCameraOn = false;

    // Mode Selection for Add Item
    let addMode = 'individual'; // 'individual' or 'category'
    let selectedCategory = null; // Stores category name when in category mode

    // AUDIO ELEMENT (Beep)
    const beep = new Audio('https://assets.mixkit.co/sfx/preview/mixkit-beep-1-1s-27.mp3');

    // Init
    window.addEventListener('load', () => {
        document.getElementById('auditDate').valueAsDate = new Date();
        checkActiveAudit();
    });

    function toggleSidebar() {
        document.getElementById('sidebar').classList.toggle('open');
        document.getElementById('overlay').classList.toggle('show');
    }

    // --- NAVIGATION ---
    
    async function checkActiveAudit() {
        const urlParams = new URLSearchParams(window.location.search);
        const paramId = urlParams.get('id');
        if (paramId) {
            await loadAuditById(paramId);
            return;
        }

        const storedId = localStorage.getItem('currentAuditId');
        if(storedId) {
            const { data } = await sb.from('audit_sessions').select('*').eq('status', 'In Progress').eq('id', storedId).maybeSingle();
            if(data) {
                loadAudit(data);
                return;
            }
        }

        loadDashboard();
    }

    async function loadDashboard() {
        currentAuditId = null;
        document.getElementById('dashboardPanel').style.display = 'block';
        document.getElementById('activeAuditPanel').style.display = 'none';
        document.getElementById('backToDashBtn').style.display = 'none';
        document.getElementById('pageTitle').innerText = "Audit Dashboard";
        localStorage.removeItem('currentAuditId');
        
        await fetchPreviousAudits();
        await fetchMergedAudits();
    }

    async function loadAuditById(id) {
        const { data } = await sb.from('audit_sessions').select('*').eq('id', id).single();
        if(data) {
            localStorage.setItem('currentAuditId', data.id);
            loadAudit(data);
        }
    }

    function loadAudit(session) {
        currentAuditId = session.id;
        document.getElementById('dashboardPanel').style.display = 'none';
        const panel = document.getElementById('activeAuditPanel');
        panel.style.display = 'block';
        document.getElementById('backToDashBtn').style.display = 'inline-flex';
        document.getElementById('pageTitle').innerText = session.audit_name;
        
        document.getElementById('auditInfoPanel').style.display = 'flex';
        document.getElementById('displayAuditName').textContent = session.audit_name;
        document.getElementById('displayInfo').textContent = `${session.created_by || '-'} - ${new Date(session.audit_date).toLocaleDateString()}`;
        
        document.getElementById('scanSection').style.display = 'flex';
        document.getElementById('historyBar').style.display = 'flex';
        document.getElementById('statsBar').style.display = 'grid';
        document.getElementById('navButtons').style.display = 'grid';
        document.getElementById('filterArea').style.display = 'flex';
        document.getElementById('tableSection').style.display = 'block';

        // Unlock scanner and reset input
        document.getElementById('scanSection').classList.remove('locked');
        document.getElementById('scanInput').focus();
        
        fetchAuditData();
    }

    // --- ADD ITEM / CATEGORY LOGIC ---

    function toggleAddPanel() {
        const panel = document.getElementById('addPanel');
        panel.classList.toggle('open');
        if (panel.classList.contains('open')) {
            // Default to individual when opening
            setMode('individual'); 
        }
    }

    function setMode(mode) {
        addMode = mode;
        document.getElementById('modeIndividual').className = mode === 'individual' ? 'mode-badge active' : 'mode-badge';
        document.getElementById('modeCategory').className = mode === 'category' ? 'mode-badge active' : 'mode-badge';
        
        const searchWrap = document.getElementById('individualSearchWrap');
        const resultsDiv = document.getElementById('searchResults');
        const summaryDiv = document.getElementById('selectionSummary');
        
        if (mode === 'individual') {
            searchWrap.style.display = 'flex';
            summaryDiv.style.display = 'block';
            // Trigger fetch if text exists
            const query = document.getElementById('inventorySearch').value;
            if(query) searchProducts(query);
        } else {
            searchWrap.style.display = 'none';
            summaryDiv.style.display = 'none';
            // Trigger categories fetch
            fetchCategories();
        }
    }

    // 1. Individual Search
    async function searchProducts(query) {
        if(!query) {
            document.getElementById('searchResults').innerHTML = '<p style="text-align:center; padding:1rem;">Type to search products...</p>';
            document.getElementById('selectionSummary').style.display = 'none';
            return;
        }

        try {
            const { data, error } = await sb.from('inventory')
                .select('*')
                .ilike('name', `%${query}%`) // Case-insensitive search
                .limit(20);

            if(error) throw error;

            const container = document.getElementById('searchResults');
            container.innerHTML = '';

            if(data.length === 0) {
                container.innerHTML = '<p style="text-align:center; padding:1rem;">No products found.</p>';
                return;
            }

            // Store selection state
            const selectedItems = new Set(); // Set of barcodes

            data.forEach(item => {
                const div = document.createElement('div');
                div.className = 'search-result-item individual-item';
                // Check if selected
                if(selectedItems.has(item.barcode)) {
                    div.classList.add('selected');
                }

                div.innerHTML = `
                    <div class="result-info">
                        <strong>${item.name}</strong>
                        <span class="result-meta">Barcode: ${item.barcode} | Balance: ${item.balance}</span>
                    </div>
                    <div style="font-size:1.5rem; color:var(--secondary);">${selectedItems.has(item.barcode) ? 'âœ“' : '+'}</div>
                `;
                
                div.onclick = () => toggleSelection(item.barcode, item.balance);
                container.appendChild(div);
            });

            updateSelectionSummary(selectedItems);

        } catch (err) {
            console.error("Search Error:", err);
        }
    }

    function toggleSelection(barcode, balance) {
        const selectedItems = new Set();
        
        // Collect currently selected items from DOM
        document.querySelectorAll('.individual-item.selected').forEach(el => {
            selectedItems.add(el.dataset.barcode);
        });

        if(selectedItems.has(barcode)) {
            selectedItems.delete(barcode); // Deselect
        } else {
            selectedItems.add(barcode); // Select
        }

        // Re-render list to show checkmarks
        // NOTE: For better UX, we should ideally just re-fetch or re-render searchResults
        // But for simplicity, we'll just update the summary for now, assuming user knows which are selected
        updateSelectionSummary(selectedItems);
    }

    // 2. Category View (Summary)
    async function fetchCategories() {
        try {
            // Fetch inventory to calculate totals
            const { data, error } = await sb.from('inventory')
                .select('name, balance') 
                .limit(200) // Limit to keep UI fast
                .order('balance', { ascending: false }); // Sort by stock desc

            if(error) throw error;

            // Group by Name (Case Insensitive)
            const grouped = {};
            data.forEach(item => {
                const name = item.name || 'Unknown';
                if(!grouped[name]) grouped[name] = 0;
                grouped[name] += (item.balance || 0);
            });

            // Convert to array
            const result = Object.keys(grouped).map(name => ({ name, balance: grouped[name] }));
            
            renderCategories(result);

        } catch (err) {
            console.error("Category Fetch Error:", err);
        }
    }

    function renderCategories(list) {
        const container = document.getElementById('searchResults');
        container.innerHTML = '';
        
        list.forEach(item => {
            const div = document.createElement('div');
            div.className = 'search-result-item category-item';
            // Check selection
            if (addMode === 'category' && selectedCategory === item.name) {
                div.classList.add('selected');
            }

            div.innerHTML = `
                <div class="result-info">
                    <strong>${item.name}</strong>
                    <span class="result-meta total-stock-highlight">Total Stock: ${item.balance}</span>
                </div>
                <div style="font-size:1.5rem; color:var(--secondary);">${addMode === 'category' && selectedCategory === item.name ? 'âœ“' : '+'}</div>
            `;
            
            div.onclick = () => {
                if (addMode === 'category') {
                    selectedCategory = (selectedCategory === item.name) ? null : item.name;
                    renderCategories(list); // Re-render to update UI
                }
            };
            container.appendChild(div);
        });

        if (addMode === 'category') {
            updateCategorySelectionSummary();
        }
    }

    // 3. Add to Audit Logic
    async function addSelectedItems() {
        if (!currentAuditId) {
            alert("Please start an audit first.");
            return;
        }

        try {
            if (addMode === 'individual') {
                // Add specific barcodes
                const selectedItems = new Set();
                document.querySelectorAll('.individual-item.selected').forEach(el => {
                    selectedItems.add(el.dataset.barcode);
                });

                if(selectedItems.size === 0) {
                    alert("Please select at least one item.");
                    return;
                }

                for (const barcode of selectedItems) {
                    await processScan(barcode);
                }

                beep.play().catch(e => console.log("Audio play failed", e));
                alert(`Added ${selectedItems.size} Items Successfully`);
                
                // Reset selection
                selectedItems.clear();
                const container = document.getElementById('searchResults');
                container.innerHTML = '<p style="text-align:center; padding:1rem;">Items added. Search again to add more.</p>';
                updateSelectionSummary(selectedItems);

            } else if (addMode === 'category') {
                // Add ALL items in category
                if (!selectedCategory) {
                    alert("Please select a category first.");
                    return;
                }

                // Fetch all items matching category name
                const { data } = await sb.from('inventory')
                    .select('*')
                    .ilike('name', `%${selectedCategory}%`)
                    .order('balance', { ascending: false });

                if (data.length === 0) {
                    alert("No items found for this category.");
                    return;
                }

                // Add all to audit
                for (const item of data) {
                    await processScan(item.barcode);
                }

                beep.play().catch(e => console.log("Audio play failed", e));
                alert(`Added all items from category: ${selectedCategory} (${data.length} items)`);

                // Reset selection
                selectedCategory = null;
                const container = document.getElementById('searchResults');
                container.innerHTML = '<p style="text-align:center; padding:1rem;">Items added. Select again to add more.</p>';
                updateCategorySelectionSummary();
            }
        } catch (err) {
            console.error("Add Items Error:", err);
            alert("Failed to add items.");
        }
    }

    function updateSelectionSummary() {
        const summary = document.getElementById('selectionSummary');
        const totalEl = document.getElementById('totalSelectedBalance');
        const label = document.querySelector('.total-label');
        
        if (addMode === 'category') {
            // Category Mode
            if(selectedCategory) {
                // Show summary
                summary.style.display = 'flex';
                label.innerText = "Selected Category Stock:";
                
                // We need to fetch the sum from DB or the local list. 
                // For speed, let's calculate from the DOM if available, otherwise fetch.
                // Since we fetched grouped list in fetchCategories, we have the balance there.
                // But to be safe, let's just count visible items logic in renderCategories
                // Or simpler: just fetch on demand.
            } else {
                summary.style.display = 'none';
            }
        } else {
            // Individual Mode
            const selectedCount = document.querySelectorAll('.individual-item.selected').length;
            if (selectedCount > 0) {
                summary.style.display = 'flex';
                label.innerText = "Selected Items Total (Approx):";
                // Summing exact balance requires iterating elements. 
                // We won't do that to avoid DOM thrashing, just show count.
                totalEl.innerText = selectedCount; 
            } else {
                summary.style.display = 'none';
            }
        }
    }

    function updateCategorySelectionSummary() {
        if(selectedCategory) {
            // We need the total. We fetched it in renderCategories.
            // But to display it here, we can just fetch it again or store in a variable.
            // For simplicity, let's just fetch the group again to get exact total.
            // (In a real app we'd cache this).
            
            const { data } = await sb.from('inventory')
                .select('name, balance')
                .ilike('name', `%${selectedCategory}%`);
            
            const total = data.reduce((a, i) => a + (i.balance || 0), 0);

            const summary = document.getElementById('selectionSummary');
            const totalEl = document.getElementById('totalSelectedBalance');
            const label = document.querySelector('.total-label');

            summary.style.display = 'flex';
            label.innerText = "Selected Category Total:";
            totalEl.innerText = total;
        }
    }

    // --- DASHBOARD FUNCTIONS ---
    
    async function fetchPreviousAudits() {
        const { data, error } = await sb.from('audit_sessions')
            .select('*')
            .eq('is_merged', false)
            .order('created_at', { ascending: false });

        if(error) return console.error(error);

        const tbody = document.getElementById('auditListBody');
        tbody.innerHTML = '';

        data.forEach(audit => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><input type="checkbox" class="audit-merge-check" value="${audit.id}"></td>
                <td><strong>${audit.audit_name}</strong></td>
                <td>${audit.outlet_name || '-'}</td>
                <td>${new Date(audit.audit_date).toLocaleDateString()}</td>
                <td>
                    <span class="badge ${audit.status === 'Closed' ? 'badge-ok' : 'badge-extra'}">${audit.status}</span>
                </td>
                <td>
                    <a class="action-link" href="report.html?id=${audit.id}">Report</a>
                    <a class="action-link" onclick="confirmEditAudit('${audit.id}')">${audit.status === 'Closed' ? 'Edit' : 'View'}</a>
                    ${audit.status === 'Closed' ? `<a class="action-link delete" onclick="deleteAudit('${audit.id}')">Delete</a>` : ''}
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    async function fetchMergedAudits() {
        const { data, error } = await sb.from('audit_sessions')
            .select('*')
            .eq('is_merged', true)
            .order('created_at', { ascending: false });

        if(error) return console.error(error);

        const tbody = document.getElementById('mergedListBody');
        tbody.innerHTML = '';

        if(data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; color:#64748b; padding:20px;">No Merged Audits Yet</td></tr>';
            return;
        }

        data.forEach(audit => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><strong>${audit.audit_name}</strong></td>
                <td>${audit.outlet_name || '-'}</td>
                <td>${audit.company_name || '-'}</td>
                <td>
                    <span class="badge badge-merged">${audit.status}</span>
                </td>
                <td>
                    <a class="action-link" href="report.html?id=${audit.id}">Report</a>
                    ${audit.status === 'In Progress' ? `<a class="action-link delete" onclick="deleteMergedAudit('${audit.id}')">Delete</a>` : ''}
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    async function createNewAudit() {
        const name = document.getElementById('auditName').value;
        const entry = document.getElementById('entryBy').value;
        const date = document.getElementById('auditDate').value;

        if(!name) return alert("Please enter Audit Name");

        try {
            const { data, error } = await sb.from('audit_sessions').insert([{
                audit_name: name,
                created_by: entry,
                audit_date: date,
                status: 'In Progress'
            }]).select().single();

            if(error) throw error;
            loadAudit(data);
        } catch (err) {
            console.error("Create Error:", err);
            alert("Failed to create audit");
        }
    }

    async function confirmEditAudit(id) {
        if(!confirm("Do you want to SAVE (Resume) and allow scanning?\n\nOK = Resume & Allow Scanning\nCancel = Discard Changes")) return;
        await resumeAudit(id);
    }

    async function resumeAudit(id) {
        try {
            const { error } = await sb.from('audit_sessions').update({ status: 'In Progress' }).eq('id', id);
            if(error) throw error;
            await loadAuditById(id);
        } catch (err) {
            alert("Failed to resume audit: " + err.message);
        }
    }

    async function deleteAudit(id) {
        if(!confirm("Are you sure? This cannot be undone.")) return;
        
        await sb.from('audit_inventory').delete().eq('audit_id', id);
        await sb.from('audit_sessions').delete().eq('id', id);

        await fetchPreviousAudits();
        await fetchMergedAudits();
    }

    // --- MERGE LOGIC ---
    async function mergeSelectedAudits() {
        const checkboxes = document.querySelectorAll('.audit-merge-check:checked');
        if(checkboxes.length < 2) {
            alert("Please select at least 2 audits to merge.");
            return;
        }

        const auditName = prompt("Merged Audit Name:", "Merged Audit " + new Date().toLocaleDateString());
        const margeBy = "System";

        if (!auditName) return;

        const ids = Array.from(checkboxes).map(cb => cb.value);

        try {
            const { data: invData, error: invError } = await sb.from('audit_inventory')
                .select('*')
                .in('audit_id', ids); 

            if(invError) throw invError;

            const map = {};
            invData.forEach(item => {
                if(!map[item.barcode]) {
                    map[item.barcode] = {
                        barcode: item.barcode,
                        name: item.name,
                        style_code: item.style_code,
                        color: item.color,
                        size: item.size,
                        balance: item.balance,
                        scanned_qty: 0
                    };
                }
                map[item.barcode].scanned_qty += item.scanned_qty;
            });

            const mergedRows = Object.values(map);

            const { data: newSession, error: sessionError } = await sb.from('audit_sessions').insert([{
                audit_name: auditName,
                created_by: margeBy,
                status: 'In Progress',
                is_merged: true,
                audit_date: new Date()
            }]).select().single();

            if(sessionError) throw new Error("Session Creation Failed: " + JSON.stringify(sessionError));

            const rowsToInsert = mergedRows.map(r => ({
                ...r,
                audit_id: newSession.id,
                last_scanned_at: new Date()
            }));
            
            await sb.from('audit_inventory').insert(rowsToInsert);
            await sb.from('audit_sessions').delete().in('id', ids);

            alert("Audits Merged Successfully! Reloading lists...");
            loadDashboard();

        } catch (err) {
            console.error("Merge Error:", err);
            alert("Merge failed! \n\nPlease check Console (F12) for detailed logs.");
        }
    }


    // --- ACTIVE AUDIT LOGIC ---

    async function closeAudit() {
        if(!confirm("Are you sure you want to Close this Audit?")) return;
        
        document.getElementById('scanSection').classList.add('locked');
        const closeBtn = document.querySelector('#auditInfoPanel button.btn-close');
        if(closeBtn) closeBtn.style.display = 'none';

        const { error } = await sb.from('audit_sessions').update({ status: 'Closed' }).eq('id', currentAuditId);

        if (error) {
            console.error("Error closing audit:", error);
            alert("Failed to close audit.");
            document.getElementById('scanSection').classList.remove('locked');
            if(closeBtn) closeBtn.style.display = 'inline-flex';
            return;
        }

        showToast("Audit Saved Successfully");
        setTimeout(() => loadDashboard(), 1000);
    }

    document.getElementById('scanInput').addEventListener('keypress', async (e) => {
        if(e.key === 'Enter') {
            const barcode = e.target.value.trim();
            if(!barcode) return;
            await processScan(barcode);
            
            // Mobile Scan Optimization: Clear input and focus for next scan
            e.target.value = '';
            e.target.focus();
        }
    });

    async function processScan(barcode) {
        try {
            const { data: master, error } = await sb.from('inventory').select('*').eq('barcode', barcode).single();
            if(error || !master) {
                alert("Product not found in Inventory!");
                return;
            }

            const { data: existing } = await sb.from('audit_inventory')
                .select('*').eq('audit_id', currentAuditId).eq('barcode', barcode).maybeSingle();

            if(existing) {
                // Increment if already scanned
                await sb.from('audit_inventory').update({ scanned_qty: existing.scanned_qty + 1, last_scanned_at: new Date() }).eq('id', existing.id);
            } else {
                // Insert new
                await sb.from('audit_inventory').insert([{
                    audit_id: currentAuditId, barcode: master.barcode, name: master.name, style_code: master.style_code,
                    color: master.color, size: master.size, balance: master.balance, scanned_qty: 1, last_scanned_at: new Date()
                }]);
            }

            showToast("Entry Successfully");
            
            // AUDIO: Play Beep
            beep.play().catch(e => console.log("Audio play failed (user interaction required)", e));

            fetchAuditData();
        } catch (err) {
            console.error("Scan Error:", err);
            alert("Scan failed: " + err.message);
        }
    }

    async function fetchAuditData() {
        const { data, error } = await sb.from('audit_inventory')
            .select('*')
            .eq('audit_id', currentAuditId)
            .order('last_scanned_at', { ascending: false });

        if(error) return console.error(error);
        auditData = data.map(item => {
            const bal = item.balance || 0;
            const sc = item.scanned_qty || 0;
            let mis = bal - sc;
            let ext = sc - bal;
            if(mis < 0) mis = 0;
            if(ext < 0) ext = 0;
            let st = 'OK';
            if(mis > 0) st = 'Missing';
            if(ext > 0) st = 'Extra';
            return { ...item, missing_qty: mis, extra_qty: ext, status: st };
        });

        updateStats();
        updateHistory();
        updateFilterDropdown();
        renderTable();
    }

    function showToast(msg) {
        const t = document.createElement('div');
        t.textContent = msg;
        t.style.cssText = "position:fixed; bottom:20px; left:50%; transform:translateX(-50%); background:#333; color:white; padding:10px 20px; border-radius:50px; z-index:2000; animation: fadein 0.5s;";
        document.body.appendChild(t);
        setTimeout(() => t.remove(), 2000);
    }

    function updateStats() {
        document.getElementById('statTotal').textContent = auditData.reduce((a,i)=>a+i.scanned_qty,0);
        document.getElementById('statMissing').textContent = auditData.reduce((a,i)=>a+i.missing_qty,0);
        document.getElementById('statExtra').textContent = auditData.reduce((a,i)=>a+i.extra_qty,0);
        document.getElementById('statOk').textContent = auditData.filter(i=>i.status==='OK').length;
        document.getElementById('statSysTotal').textContent = auditData.reduce((a,i)=>a+(i.balance||0),0);
    }

    function updateHistory() {
        const container = document.getElementById('historyContainer');
        container.innerHTML = '';
        auditData.slice(0,10).forEach(i => {
            const d = document.createElement('div');
            d.className = 'history-item';
            d.innerHTML = `<span class="history-bc">${i.barcode}</span> ${i.name} <br><span class="history-bal">Qty: ${i.scanned_qty} | Bal: ${i.balance}</span>`;
            container.appendChild(d);
        });
    }

    function updateFilterDropdown() {
        const sel = document.getElementById('productFilter');
        const currentVal = sel.value;
        const uniqueNames = [...new Set(auditData.map(i=>i.name))].sort();
        sel.innerHTML = '<option value="all">All Scanned Products</option>';
        uniqueNames.forEach(n => sel.innerHTML += `<option value="${n}">${n}</option>`);
        sel.value = currentVal;
    }

    function renderTable() {
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';
        const filterName = document.getElementById('productFilter').value;

        const filtered = auditData.filter(i => filterName === 'all' || i.name === filterName);

        filtered.forEach(i => {
            const tr = document.createElement('tr');
            const badgeClass = i.status === 'Missing' ? 'badge-missing' : (i.status === 'Extra' ? 'badge-extra' : 'badge-ok');
            
            tr.innerHTML = `
                <td>${i.barcode}</td>
                <td>${i.name}</td>
                <td>${i.color||'-'} / ${i.size||'-'}</td>
                <td>${i.balance}</td>
                <td style="font-weight:bold; color:var(--primary);">${i.scanned_qty}</td>
                <td style="color:red; font-weight:bold;">${i.missing_qty}</td>
                <td style="color:blue; font-weight:bold;">${i.extra_qty}</td>
                <td><span class="badge ${badgeClass}">${i.status}</span></td>
                <td>
                    <button class="action-btn btn-edit" onclick="editItem(${i.id}, ${i.scanned_qty})">Edit</button>
                    <button class="action-btn btn-delete" onclick="deleteItem(${i.id})">Delete</button>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    async function editItem(id, currentQty) {
        let input = prompt(`Edit Scanned Qty:`, currentQty);
        if (input === null) return;
        let newQty = parseInt(input);
        if (isNaN(newQty) || newQty < 0) {
            alert("Please enter a valid positive number.");
            return;
        }
        const { error } = await sb.from('audit_inventory').update({ scanned_qty: newQty, last_scanned_at: new Date() }).eq('id', id);
        if (error) {
            alert("Failed to update item.");
        } else {
            showToast("Updated Successfully");
            fetchAuditData();
        }
    }

    async function deleteItem(id) {
        if(!confirm("Delete this scan record?")) return;
        try {
            await sb.from('audit_inventory').delete().eq('id', id);
            fetchAuditData();
        } catch (err) {
            alert("Failed to delete.");
        }
    }
    
    async function deleteMergedAudit(id) {
        if(!confirm("Are you sure? This cannot be undone.")) return;
        try {
            await sb.from('audit_inventory').delete().eq('audit_id', id);
            await sb.from('audit_sessions').delete().eq('id', id);
            fetchMergedAudits();
        } catch (err) {
            console.error(err);
            alert("Failed to delete.");
        }
    }

    function goToSummary() { window.location.href = `summ.html?id=${currentAuditId}`; }
    function goToReport() { window.location.href = `report.html?id=${currentAuditId}`; }

    async function toggleCamera() {
        const wrapper = document.getElementById('reader-wrapper');
        const btn = document.getElementById('camBtn');
        if (isCameraOn) {
            if(html5QrCode) { await html5QrCode.stop(); await html5QrCode.clear(); }
            wrapper.style.display = 'none';
            isCameraOn = false;
            btn.textContent = 'ðŸ“¸ Cam';
        } else {
            wrapper.style.display = 'block';
            isCameraOn = true;
            btn.textContent = 'â¹ Stop';
            html5QrCode = new Html5Qrcode("reader");
            html5QrCode.start({ facingMode: "environment" }, { fps: 15, qrbox: { width: 250, height: 200 } }, async (t) => { await processScan(t); }, (e)=>{});
        }
    }
</script>
</body>
</html>
